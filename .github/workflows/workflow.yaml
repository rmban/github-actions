name: TF Workflow
on:
  push:
    branches:
      - main
  pull_request:
  
env:
  workspaceURL: ${{ secrets.TFE_WORKSPACE_URL }}
    
  jobs: 
    Terraform: 
      name: "Terraform"
      runs-on: ubuntu-latest
      
      steps: 
        - name: Checkout Code
          uses: actions/checkout@v2
          
        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v1
          with:
            cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
            
        - name: Terraform Format
          id: fmt
          run: terraform fmt -check
          
        - name: Terraform init
          id: init
          run: terraform init
          
        - name: Terraform Plan
          id: plan
          if: github.event_name == 'pull_request'
          run: terraform plan -no-color
          continue-on-error: true
          
        - uses: actions/github-script@0.9.0
          if: github.event_name == 'pull_request'
          env: 
            PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
          with:
            github-token: ${{secrets.TF_API_TOKEN }}
              
        - name: Terraform Plan Status
          if: github.ref == 'refs/heads/main' && github.event_name == 'push'
          run: terraform apply -auto-approve
